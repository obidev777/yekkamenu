{% extends "base.html" %}

{% block title %}Inicio - {{ config.nombre_restaurante }}{% endblock %}

{% block content %}
<!-- Hero Section Minimalista -->
<section class="hero-minimal">
    <div class="hero-content-minimal">
        <h1>{{ config.nombre_restaurante }}</h1>
        <p>Disfruta de sabores autenticos en cada bocado</p>
    </div>
</section>

<!-- Menu Minimalista -->
<section class="section-minimal" >
    <div class="container-minimal">
        <div class="menu-header-minimal">
            <h2 id="menu_platos_ir">Nuestro Menu</h2>
            <p >Platos preparados con ingredientes frescos</p>

            <!-- Filtros Minimalistas -->
            <div class="menu-filters-minimal">
                <div class="search-box-minimal">
                    <input type="text" id="search-input-minimal" placeholder="Buscar platos..." value="{{ search }}">
                    <span id="search-btn-minimal" class="search-icon">&#128269;</span>
                </div>

                <div class="category-filters-minimal">
                    <div class="category-scroll" id="categories-container">
                        <!-- Las categorías se cargarán dinámicamente con JavaScript -->
                        <button type="button" class="category-filter-minimal active" data-category-id="all">
                            Todas
                        </button>
                        <!-- Las categorías se insertarán aquí mediante JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Plato Container -->
        <div id="menu_platos" class="platos-grid-minimal">
            <!-- Los platos se cargarán dinámicamente con JavaScript -->
        </div>

        <!-- Empty State (inicialmente oculto) -->
        <div id="empty-state-minimal" class="empty-state-minimal" style="display: none;">
            <div class="empty-icon">&#127860;</div>
            <h3>No se encontraron platos</h3>
            <p>Intenta con otros filtros de busqueda</p>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos minimalistas para movil */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        line-height: 1.5;
        padding: 0;
        margin: 0;
    }

    .container-minimal {
        width: 100%;
        padding: 0 15px;
    }

    /* Hero Section Minimalista */
    .hero-minimal {
        background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7));
        padding: 30px 20px;
        text-align: center;
        color: white;
    }

    .hero-content-minimal h1 {
        font-size: 24px;
        margin: 0 0 10px;
        font-weight: 700;
    }

    .hero-content-minimal p {
        font-size: 14px;
        margin: 0 0 20px;
        opacity: 0.9;
    }

    .hero-buttons-minimal {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    /* Botones Minimalistas */
    .btn-minimal {
        display: inline-block;
        padding: 10px 16px;
        background-color: #e74c3c;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-outline-minimal {
        background-color: transparent;
        border: 1px solid white;
        color: white;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e74c3c;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
    }

    /* Seccion Menu */
    .section-minimal {
        padding: 20px 0;
    }

    .menu-header-minimal {
        text-align: center;
        margin-bottom: 20px;
    }

        .menu-header-minimal h2 {
            font-size: 20px;
            margin: 0 0 8px;
            color: #2c3e50;
        }

        .menu-header-minimal p {
            margin: 0 0 15px;
            color: #666;
            font-size: 14px;
        }

    /* Busqueda y Filtros */
    .search-box-minimal {
        display: flex;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        background: white;
    }

    #search-input-minimal {
        flex: 1;
        padding: 10px 12px;
        border: none;
        outline: none;
        font-size: 16px;
    }

    .search-icon {
        padding: 10px 12px;
        background: #2c3e50;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .category-filters-minimal {
        margin-bottom: 15px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 5px;
    }

    .category-scroll {
        display: flex;
        gap: 8px;
    }

    .category-filter-minimal {
        padding: 6px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 16px;
        text-decoration: none;
        color: #333;
        white-space: nowrap;
        font-size: 13px;
        cursor: pointer;
    }

        .category-filter-minimal.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

    /* Grid de Platos */
    .platos-grid-minimal {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .plato-card-minimal {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .plato-image-minimal {
        height: 160px;
        overflow: hidden;
    }

        .plato-image-minimal img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .plato-info-minimal {
        padding: 12px;
    }

        .plato-info-minimal h3 {
            margin: 0 0 6px;
            font-size: 16px;
            color: #2c3e50;
        }

    .plato-description-minimal {
        margin: 0 0 12px;
        color: #666;
        font-size: 13px;
        line-height: 1.4;
    }

    .plato-details-minimal {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .plato-price-minimal {
        font-weight: bold;
        font-size: 16px;
        color: #e74c3c;
    }

    .plato-actions-minimal {
        display: flex;
        gap: 6px;
    }

    /* Modal Minimalista */
    .modal-minimal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 15px;
    }

    .modal-content-minimal {
        background: white;
        border-radius: 8px;
        width: 100%;
        max-width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header-minimal {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
    }

        .modal-header-minimal h3 {
            margin: 0;
            font-size: 18px;
        }

    .modal-close {
        font-size: 20px;
        cursor: pointer;
        background: none;
        border: none;
        font-weight: bold;
    }

    .modal-body-minimal {
        padding: 15px;
    }

    .modal-plato-image-minimal {
        height: 180px;
        margin-bottom: 12px;
        border-radius: 6px;
        overflow: hidden;
    }

        .modal-plato-image-minimal img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .modal-plato-description-minimal {
        margin: 0 0 12px;
        font-size: 14px;
    }

    .modal-plato-price-minimal {
        font-weight: bold;
        font-size: 18px;
        color: #e74c3c;
        margin-bottom: 12px;
    }

    .modal-plato-ingredients-minimal h4 {
        margin: 0 0 8px;
        font-size: 15px;
    }

    .modal-plato-ingredients-minimal ul {
        margin: 0;
        padding-left: 18px;
    }

    .modal-plato-ingredients-minimal li {
        margin-bottom: 4px;
        font-size: 13px;
    }

    .modal-footer-minimal {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 12px 15px;
        border-top: 1px solid #ddd;
    }

    .btn-primary-minimal {
        background-color: #e74c3c;
        color: white;
    }

    /* Estado vacio */
    .empty-state-minimal {
        text-align: center;
        padding: 30px 15px;
        color: #666;
    }

    .empty-icon {
        font-size: 40px;
        margin-bottom: 12px;
    }

    .empty-state-minimal h3 {
        margin: 0 0 8px;
        font-size: 18px;
    }

    .empty-state-minimal p {
        margin: 0;
        font-size: 14px;
    }

    /* Loader */
    .loader-minimal {
        display: none;
        text-align: center;
        padding: 20px;
    }

        .loader-minimal .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let currentCategory = 'all';
    let currentSearch = '';
    let allPlatos = [];

    // Funcion para cargar categorias mediante fetch
    function loadCategories() {
        fetch('/api/categorias')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar categorias');
                }
                return response.json();
            })
            .then(categorias => {
                const categoriesContainer = document.getElementById('categories-container');

                // Agregar cada categoria al contenedor
                categorias.forEach(categoria => {
                    const categoryButton = document.createElement('button');
                    categoryButton.type = 'button';
                    categoryButton.className = 'category-filter-minimal';
                    categoryButton.dataset.categoryId = categoria.id;
                    categoryButton.textContent = categoria.nombre;

                    categoryButton.addEventListener('click', function () {
                        // Remover clase activa de todos los botones
                        document.querySelectorAll('.category-filter-minimal').forEach(btn => {
                            btn.classList.remove('active');
                        });

                        // Agregar clase activa al botón clickeado
                        this.classList.add('active');

                        // Actualizar categoria actual y cargar platos
                        currentCategory = this.dataset.categoryId;
                        loadPlatos();
                    });

                    categoriesContainer.appendChild(categoryButton);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Funcion para cargar platos mediante fetch
    function loadPlatos() {
        // Mostrar loader
        document.getElementById('loader-minimal').style.display = 'block';

        // Construir URL con parámetros
        let url = '/api/platos?';
        if (currentCategory !== 'all') {
            url += `categoria_id=${currentCategory}&`;
        }
        if (currentSearch) {
            url += `search=${encodeURIComponent(currentSearch)}&`;
        }

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar platos');
                }
                return response.json();
            })
            .then(platos => {
                // Ocultar loader
                document.getElementById('loader-minimal').style.display = 'none';

                // Guardar platos para uso posterior
                allPlatos = platos;

                // Renderizar platos
                renderPlatos(platos);

                // Mostrar u ocultar estado vacío
                const emptyState = document.getElementById('empty-state-minimal');
                if (platos.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loader-minimal').style.display = 'none';
            });
    }

    // Funcion para renderizar platos en el DOM
    function renderPlatos(platos) {
        const platosContainer = document.getElementById('menu_platos');
        platosContainer.innerHTML = '';

        platos.forEach(plato => {
            const platoCard = document.createElement('div');
            platoCard.className = 'plato-card-minimal';

            // Construir HTML del plato
            platoCard.innerHTML = `
                <div class="plato-info-minimal">
                    <h3>${plato.nombre}</h3>
                    <p class="plato-description-minimal">${plato.descripcion ? truncateText(plato.descripcion, 60) : ''}</p>
                    <div class="plato-details-minimal">
                        <div class="plato-price-minimal">$${plato.precio_venta.toFixed(2)}</div>
                        <div class="plato-actions-minimal">
                            <button class="btn-icon" onclick="openModal('platoModal${plato.id}')">i</button>
                        </div>
                    </div>
                </div>
            `;

            platosContainer.appendChild(platoCard);

            // Crear modal para este plato
            createPlatoModal(plato);
        });
    }

    // Funcion para crear modales de platos
    function createPlatoModal(plato) {
        // Verificar si el modal ya existe
        if (document.getElementById(`platoModal${plato.id}`)) {
            return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal-minimal';
        modal.id = `platoModal${plato.id}`;

        // Construir ingredientes HTML si existen
        let ingredientesHTML = '';
        if (plato.ingredientes && plato.ingredientes.length > 0) {
            ingredientesHTML = `
                <div class="modal-plato-ingredients-minimal">
                    <h4>Ingredientes:</h4>
                    <ul>
                        ${plato.ingredientes.map(ing =>
                `<li>${ing.producto.nombre} - ${ing.cantidad} ${ing.producto.unidad_medida}</li>`
            ).join('')}
                    </ul>
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="modal-content-minimal">
                <div class="modal-header-minimal">
                    <h3>${plato.nombre}</h3>
                    <span class="modal-close" onclick="closeModal('platoModal${plato.id}')">X</span>
                </div>
                <div class="modal-body-minimal">
                    <div class="modal-plato-image-minimal">
                        <img src="${plato.imagen ? '/uploads/' + plato.imagen : '/static/images/default-dish.jpg'}" alt="${plato.nombre}">
                    </div>
                    <p class="modal-plato-description-minimal">${plato.descripcion || ''}</p>
                    <div class="modal-plato-price-minimal">$${plato.precio_venta.toFixed(2)}</div>
                    ${ingredientesHTML}
                </div>
                <div class="modal-footer-minimal">
                    <button class="btn-minimal" onclick="closeModal('platoModal${plato.id}')">Cerrar</button>
                    <button class="btn-minimal btn-primary-minimal" onclick="addToCart(${plato.id})">Agregar</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // Funcion auxiliar para truncar texto
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // Funcionalidad de busqueda con debounce
    function setupSearch() {
        const searchInput = document.getElementById('search-input-minimal');
        const searchBtn = document.getElementById('search-btn-minimal');

        let searchTimeout;

        const performSearch = function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = searchInput.value;
                loadPlatos();
            }, 800);
        };

        if (searchInput) {
            searchInput.addEventListener('input', performSearch);
        }

        if (searchBtn) {
            searchBtn.addEventListener('click', performSearch);
        }
    }

    // Funciones para modales
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera del contenido
    function setupModals() {
        document.querySelectorAll('.modal-minimal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    }

    // Funcion para agregar platos al carrito
    function addToCart(platoId) {
        // Buscar el plato en los datos cargados
        const plato = allPlatos.find(p => p.id === platoId);

        if (!plato) {
            console.error('Plato no encontrado');
            return;
        }

        // Obtener el carrito actual de localStorage o inicializar uno nuevo
        let cart = JSON.parse(localStorage.getItem('carrito')) || [];

        // Buscar si el plato ya esta en el carrito
        const existingItemIndex = cart.findIndex(item => item.id === platoId);

        if (existingItemIndex >= 0) {
            // Si ya existe, incrementar la cantidad
            cart[existingItemIndex].cantidad += 1;
        } else {
            // Si no existe, agregar nuevo item al carrito
            cart.push({
                id: platoId,
                nombre: plato.nombre,
                precio: plato.precio_venta,
                imagen: plato.imagen || 'default-dish.jpg',
                cantidad: 1
            });
        }

        // Guardar carrito actualizado en localStorage
        localStorage.setItem('carrito', JSON.stringify(cart));

        // Actualizar contador del carrito
        updateCartCounter();

        // Mostrar feedback visual al usuario
        showCartFeedback('Plato agregado al carrito');

        // Cerrar el modal
        closeModal('platoModal' + platoId);
    }

    // Actualizar contador de items en el carrito
    function updateCartCounter() {
        const cart = JSON.parse(localStorage.getItem('carrito')) || [];
        const totalItems = cart.length;
        // Buscar o crear el contador
        let counter = document.getElementById('cart-counter');
        if (!counter) {
            counter = document.createElement('span');
            counter.id = 'cart-counter';
            counter.style.cssText = 'position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;';

            const cartIcon = document.querySelector('.cart-icon');
            if (cartIcon) {
                cartIcon.style.position = 'relative';
                cartIcon.appendChild(counter);
            }
        }

        counter.textContent = totalItems;
        counter.style.display = totalItems > 0 ? 'flex' : 'none';
    }

    // Mostrar feedback visual
    function showCartFeedback(message) {
        // Eliminar feedback anterior si existe
        const existingFeedback = document.getElementById('cart-feedback');
        if (existingFeedback) {
            existingFeedback.remove();
        }

        // Crear elemento de feedback
        const feedback = document.createElement('div');
        feedback.id = 'cart-feedback';
        feedback.textContent = message;
        feedback.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; font-size: 14px;';

        document.body.appendChild(feedback);

        // Remover despues de 2 segundos
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 2000);
    }

    // Inicializar cuando el DOM este listo
    document.addEventListener('DOMContentLoaded', function () {
        // Agregar elemento loader al DOM
        const loader = document.createElement('div');
        loader.id = 'loader-minimal';
        loader.className = 'loader-minimal';
        loader.innerHTML = '<div class="spinner"></div><p>Cargando platos...</p>';
        loader.style.display = 'none';
        document.querySelector('.container-minimal').appendChild(loader);

        // Cargar categorias y platos
        loadCategories();
        loadPlatos();

        // Configurar funcionalidades
        setupSearch();
        setupModals();
        updateCartCounter();

        // Scroll suave para los enlaces
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });
    });
</script>
{% endblock %}